<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Weniv Analytics Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Weniv Analytics Dashboard</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
          aria-controls="navbarNav"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div
          class="collapse navbar-collapse justify-content-end"
          id="navbarNav"
        >
          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="index.html"
                >Total Page Views</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="detail.html">Detail Page Views</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Click Event</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Downloads</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container mt-4">
      <div class="row">
        <div class="col-md-4">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">DAU(Daily Active Users)</h5>
              <div id="dau"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">WAU(Weekly Active Users)</h5>
              <div id="wau"></div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">MAU(Monthly Active Users)</h5>
              <div id="mau"></div>
            </div>
          </div>
        </div>
        <div class="col-md-12">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">Page Views</h5>
              <div class="dropdown">
                <button
                  class="btn btn-secondary dropdown-toggle"
                  type="button"
                  id="dropdownMenuButton"
                  data-bs-toggle="dropdown"
                  aria-expanded="false"
                >
                  기간 설정
                </button>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <li><a class="dropdown-item" href="#">Daily</a></li>
                  <li><a class="dropdown-item" href="#">Weekly</a></li>
                  <li><a class="dropdown-item" href="#">Monthly</a></li>
                </ul>
              </div>
              <canvas id="pageViewChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">Top 5 Pages</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item">Page 1 9842</li>
                <li class="list-group-item">Page 2 9842</li>
                <li class="list-group-item">Page 3 9842</li>
                <li class="list-group-item">Page 4 9842</li>
                <li class="list-group-item">Page 5 9842</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">Top 5 Pages</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item">Page 1 9842</li>
                <li class="list-group-item">Page 2 9842</li>
                <li class="list-group-item">Page 3 9842</li>
                <li class="list-group-item">Page 4 9842</li>
                <li class="list-group-item">Page 5 9842</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card mt-4">
            <div class="card-body">
              <h5 class="card-title">Top 5 Pages</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item">Page 1 9842</li>
                <li class="list-group-item">Page 2 9842</li>
                <li class="list-group-item">Page 3 9842</li>
                <li class="list-group-item">Page 4 9842</li>
                <li class="list-group-item">Page 5 9842</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 현재 날짜를 가져오는 함수
      const getCurrentDate = () => {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0"); // 월은 0부터 시작하므로 1을 더하고 문자열로 변환
        const day = String(today.getDate()).padStart(2, "0"); // 날짜를 가져옴
        let previousMonth = parseInt(month) - 1;
        if (previousMonth === 0) {
          year = String(parseInt(year) - 1);
          previousMonth = "12";
        } else {
          previousMonth = String(previousMonth).padStart(2, "0");
        }
        return [`${year}${month}${day}`, `${year}${previousMonth}${day}`]; // YYYYMMDD 형식의 문자열로 반환
      };

      // 현재 날짜를 가져옴
      const currentDate = getCurrentDate()[0];
      const previousMonthDate = getCurrentDate()[1];

      fetch(
        `https://analytics.weniv.co.kr/analytics/pageviews?url=https&date_start=${previousMonthDate}&date_end=${currentDate}&interval=weekly`
      )
        .then((response) => response.json())
        .then((data) => {
          const getPreviousMonthDates = (currentDate) => {
            const year = currentDate.substr(0, 4);
            const month = currentDate.substr(4, 2);
            let previousYear = year;
            let previousMonth = parseInt(month) - 1;
            if (previousMonth === 0) {
              previousYear = String(parseInt(year) - 1);
              previousMonth = "12";
            } else {
              previousMonth = String(previousMonth).padStart(2, "0");
            }
            const previousMonthStartDate = `${previousYear}${previousMonth}01`; // 전 월의 시작일
            const previousMonthEndDate = `${year}${month}01`; // 전 월의 종료일
            return [previousMonthStartDate, previousMonthEndDate]; // 전 월의 시작일과 종료일을 배열로 반환
          };

          // 전 월의 시작일과 종료일을 가져옴
          const [previousMonthStartDate, previousMonthEndDate] =
            getPreviousMonthDates(currentDate);

          // 전 월의 데이터를 가져옴
          let previousMonthData =
            data.data[`${previousMonthStartDate}-${previousMonthEndDate}`];

          // 데이터가 없는 경우에는 그 이전 월의 데이터를 가져옴
          if (!previousMonthData) {
            for (const key in data.data) {
              if (Object.hasOwnProperty.call(data.data, key)) {
                previousMonthData = data.data[key].num;
              }
            }
          }
          document.getElementById("mau").innerText = previousMonthData;
        })
        .catch((error) => console.error("Error fetching MAU data:", error));
      fetch(
        `https://analytics.weniv.co.kr/analytics/pageviews?url=https&date_start=${previousMonthDate}&date_end=${currentDate}&interval=weekly`
      )
        .then((response) => response.json())
        .then((data) => {
          // 전 주의 시작일과 종료일을 계산하는 함수
          const getPreviousWeekDates = (currentDate) => {
            const today = new Date(
              currentDate.substr(0, 4),
              Number(currentDate.substr(4, 2)) - 1,
              currentDate.substr(6, 2)
            ); // 현재 날짜 객체 생성
            const previousWeekStart = new Date(
              today.getTime() - 7 * 24 * 60 * 60 * 1000
            ); // 전 주의 시작일 계산
            const previousWeekEnd = new Date(
              today.getTime() - 1 * 24 * 60 * 60 * 1000
            ); // 전 주의 종료일 계산
            const previousWeekStartDate = `${previousWeekStart.getFullYear()}${String(
              previousWeekStart.getMonth() + 1
            ).padStart(2, "0")}${String(previousWeekStart.getDate()).padStart(
              2,
              "0"
            )}`; // YYYYMMDD 형식의 문자열로 변환
            const previousWeekEndDate = `${previousWeekEnd.getFullYear()}${String(
              previousWeekEnd.getMonth() + 1
            ).padStart(2, "0")}${String(previousWeekEnd.getDate()).padStart(
              2,
              "0"
            )}`; // YYYYMMDD 형식의 문자열로 변환
            return [previousWeekStartDate, previousWeekEndDate]; // 전 주의 시작일과 종료일을 배열로 반환
          };

          // 전 주의 시작일과 종료일을 가져옴
          const [previousWeekStartDate, previousWeekEndDate] =
            getPreviousWeekDates(currentDate);

          // 전 주의 데이터를 가져옴
          let previousWeekData =
            data.data[`${previousWeekStartDate}-${previousWeekEndDate}`];

          // 데이터가 없는 경우에는 그 이전 주의 데이터를 가져옴
          if (!previousWeekData) {
            for (const key in data.data) {
              if (Object.hasOwnProperty.call(data.data, key)) {
                previousWeekData = data.data[key].num;
              }
            }
          }
          document.getElementById("wau").innerText = previousWeekData;
        })
        .catch((error) => console.error("Error fetching MAU data:", error));

      fetch(
        `https://analytics.weniv.co.kr/analytics/pageviews?url=https&date_start=${previousMonthDate}&date_end=${currentDate}&interval = `,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
          },
        }
      )
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          let labels = Object.keys(data.data);
          let values = Object.values(data.data).map((item) => item.num);

          document.getElementById("dau").innerText = values[values.length - 1]; // 'mau'는 받아온 데이터의 키에 따라 수정
        });
      let myChart;
      const graph = (interval) => {
        // 30일 페이지뷰 데이터 (임의의 데이터입니다. 실제로는 서버에서 가져와야 합니다.)
        fetch(
          `https://analytics.weniv.co.kr/analytics/pageviews?url=https&date_start=${previousMonthDate}&date_end=${currentDate}&interval=${interval}`, //
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          }
        )
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            let labels = Object.keys(data.data);
            let values = Object.values(data.data).map((item) => item.num);
            const pageViewData = {
              labels: labels,
              values: values,
            };

            // 차트 그리기
            const ctx = document
              .getElementById("pageViewChart")
              .getContext("2d");
            // 이전 차트 파괴
            if (myChart) {
              myChart.destroy();
            }
            myChart = new Chart(ctx, {
              type: "line",
              data: {
                labels: pageViewData.labels,
                datasets: [
                  {
                    label: "Page Views",
                    data: pageViewData.values,
                    backgroundColor: "rgba(75, 192, 192, 0.6)",
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                scales: {
                  y: {
                    beginAtZero: true,
                    stepSize: 100,
                  },
                },
              },
            });
          })
          .catch((error) => console.error("Error:", error));
      };

      let interval = "daily";
      graph(interval);

      // 모든 dropdown-item 요소 가져오기
      const dropdownItems = document.querySelectorAll(".dropdown-item");
      // if interval

      // 클릭 이벤트 핸들러 내부에서 interval 변수를 정의하고 값 할당
      dropdownItems.forEach((item) => {
        item.addEventListener("click", function () {
          // 클릭된 dropdown-item의 텍스트 가져오기
          interval = this.innerText.toLowerCase();
          // 새로운 차트 그리기
          graph(interval);
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
